<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Fichaje Trabajadores</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0; 
            padding: 15px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid #667eea;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 25px 0;
            flex-wrap: wrap;
        }
        
        .control-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 180px;
            justify-content: center;
        }
        
        .export-btn {
            background: #4CAF50;
            color: white;
        }
        
        .clear-btn {
            background: #ff9800;
            color: white;
        }
        
        .view-btn {
            background: #2196F3;
            color: white;
        }
        
        .control-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .workers-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 25px 0;
        }
        
        @media (min-width: 768px) {
            .workers-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        .worker-card {
            background: #fff;
            border: 3px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        .worker-card.active {
            border-color: #4CAF50;
            background: #f1f8e9;
        }
        
        .worker-id {
            font-weight: bold;
            font-size: 18px;
            color: #333;
            margin-bottom: 5px;
        }
        
        .worker-name {
            color: #666;
            margin-bottom: 15px;
            font-size: 14px;
        }
        
        .action-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            width: 100%;
            font-size: 14px;
            font-weight: bold;
            transition: background 0.3s;
        }
        
        .action-btn.salir {
            background: #f44336;
        }
        
        .action-btn:hover {
            opacity: 0.9;
        }
        
        .status {
            font-size: 12px;
            margin-top: 10px;
            color: #777;
            font-style: italic;
        }
        
        .logs-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px solid #e9ecef;
        }
        
        .logs-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        #logsContainer {
            max-height: 300px;
            overflow-y: auto;
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        
        .log-entry {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .log-time {
            color: #6c757d;
            font-size: 12px;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: #4CAF50;
            color: white;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: none;
            z-index: 1000;
        }
        
        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üë∑ SISTEMA DE FICHAJE - 8 TRABAJADORES</h1>
        
        <!-- CONTROLES PRINCIPALES -->
        <div class="controls">
            <button class="control-btn export-btn" onclick="exportarDatos()">
                üì§ EXPORTAR DATOS
            </button>
            <button class="control-btn clear-btn" onclick="limpiarHoy()">
                üóëÔ∏è LIMPIAR HOY
            </button>
            <button class="control-btn view-btn" onclick="toggleLogs()">
                üìã VER REGISTROS
            </button>
        </div>
        
        <!-- GRID DE TRABAJADORES -->
        <div class="workers-grid" id="workersGrid">
            <!-- Los trabajadores se generan con JavaScript -->
        </div>
        
        <!-- SECCI√ìN DE REGISTROS -->
        <div class="logs-section" id="logsSection" style="display: none;">
            <div class="logs-header">
                <h3>üìù REGISTROS DE HOY</h3>
                <button class="delete-btn" onclick="limpiarRegistros()">
                    Borrar Registros
                </button>
            </div>
            <div id="logsContainer">
                <!-- Los registros se cargan aqu√≠ -->
            </div>
        </div>
        
        <!-- NOTIFICACI√ìN -->
        <div class="notification" id="notification"></div>
    </div>

    <script>
        // ================= CONFIGURACI√ìN =================
        const TRABAJADORES = [
            { id: 1, nombre: "Trabajador 1", estado: "fuera", ultimoRegistro: "" },
            { id: 2, nombre: "Trabajador 2", estado: "fuera", ultimoRegistro: "" },
            { id: 3, nombre: "Trabajador 3", estado: "fuera", ultimoRegistro: "" },
            { id: 4, nombre: "Trabajador 4", estado: "fuera", ultimoRegistro: "" },
            { id: 5, nombre: "Trabajador 5", estado: "fuera", ultimoRegistro: "" },
            { id: 6, nombre: "Trabajador 6", estado: "fuera", ultimoRegistro: "" },
            { id: 7, nombre: "Trabajador 7", estado: "fuera", ultimoRegistro: "" },
            { id: 8, nombre: "Trabajador 8", estado: "fuera", ultimoRegistro: "" }
        ];
        
        const LOGS_KEY = 'fichaje_logs';
        const STATE_KEY = 'fichaje_estado';
        
        // ================= INICIALIZACI√ìN =================
        document.addEventListener('DOMContentLoaded', function() {
            cargarEstado();
            renderizarTrabajadores();
            cargarRegistros();
            
            // IMPORTANTE: Configurar comunicaci√≥n con App Inventor
            if (window.AppInventor) {
                window.AppInventor.setWebViewString("app_ready");
            }
        });
        
        // ================= FUNCIONES PRINCIPALES =================
        
        // 1. RENDERIZAR TRABAJADORES
        function renderizarTrabajadores() {
            const grid = document.getElementById('workersGrid');
            grid.innerHTML = '';
            
            TRABAJADORES.forEach(trabajador => {
                const card = document.createElement('div');
                card.className = `worker-card ${trabajador.estado === 'dentro' ? 'active' : ''}`;
                
                card.innerHTML = `
                    <div class="worker-id">ID ${trabajador.id}</div>
                    <div class="worker-name">${trabajador.nombre}</div>
                    <button class="action-btn ${trabajador.estado === 'dentro' ? 'salir' : ''}" 
                            onclick="registrarEntradaSalida(${trabajador.id})">
                        ${trabajador.estado === 'dentro' ? '‚è∏Ô∏è SALIR' : '‚ñ∂Ô∏è ENTRAR'}
                    </button>
                    <div class="status">${trabajador.ultimoRegistro || 'Sin registro hoy'}</div>
                `;
                
                grid.appendChild(card);
            });
        }
        
        // 2. REGISTRAR ENTRADA/SALIDA
        function registrarEntradaSalida(id) {
            const trabajador = TRABAJADORES.find(t => t.id === id);
            const ahora = new Date();
            const hora = ahora.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            const fecha = ahora.toLocaleDateString();
            
            let mensaje = '';
            
            if (trabajador.estado === 'fuera') {
                // ENTRADA
                trabajador.estado = 'dentro';
                trabajador.ultimoRegistro = `Entrada: ${hora}`;
                mensaje = `üë§ Trabajador ${id}: ENTRADA a las ${hora}`;
            } else {
                // SALIDA
                trabajador.estado = 'fuera';
                trabajador.ultimoRegistro = `Salida: ${hora}`;
                mensaje = `üë§ Trabajador ${id}: SALIDA a las ${hora}`;
            }
            
            // Guardar registro
            guardarRegistro(mensaje);
            guardarEstado();
            renderizarTrabajadores();
            
            // Mostrar notificaci√≥n
            mostrarNotificacion(mensaje);
            
            // Enviar a App Inventor si est√° disponible
            if (window.AppInventor) {
                window.AppInventor.setWebViewString(`accion:${mensaje}`);
            }
        }
        
        // 3. EXPORTAR DATOS
        function exportarDatos() {
            const ahora = new Date();
            let contenido = `================================\n`;
            contenido += `INFORME DE FICHAJE\n`;
            contenido += `Fecha: ${ahora.toLocaleDateString()}\n`;
            contenido += `Hora de generaci√≥n: ${ahora.toLocaleTimeString()}\n`;
            contenido += `================================\n\n`;
            
            // Estado actual
            contenido += `ESTADO ACTUAL:\n`;
            contenido += `================\n`;
            TRABAJADORES.forEach(t => {
                contenido += `ID ${t.id}: ${t.nombre}\n`;
                contenido += `  Estado: ${t.estado === 'dentro' ? 'üîµ DENTRO' : 'üî¥ FUERA'}\n`;
                contenido += `  √öltimo: ${t.ultimoRegistro || 'Sin registro'}\n\n`;
            });
            
            // Historial del d√≠a
            contenido += `\nHISTORIAL DEL D√çA:\n`;
            contenido += `===================\n`;
            const logs = obtenerRegistros();
            logs.forEach(log => {
                contenido += `${log}\n`;
            });
            
            contenido += `\n================================\n`;
            contenido += `Total registros hoy: ${logs.length}\n`;
            contenido += `================================`;
            
            // Crear y descargar archivo
            const blob = new Blob([contenido], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `FICHAJE_${ahora.getDate()}_${ahora.getMonth()+1}_${ahora.getFullYear()}.txt`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            // Notificaci√≥n
            mostrarNotificacion('‚úÖ Datos exportados correctamente');
            
            // Enviar a App Inventor
            if (window.AppInventor) {
                window.AppInventor.setWebViewString('exportado:success');
            }
        }
        
        // 4. LIMPIAR HOY (reset total)
        function limpiarHoy() {
            if (confirm('‚ö†Ô∏è ¬øEST√ÅS SEGURO?\n\nEsto resetear√° TODOS los trabajadores a "FUERA" y eliminar√° todos los registros del d√≠a.')) {
                // Resetear trabajadores
                TRABAJADORES.forEach(t => {
                    t.estado = 'fuera';
                    t.ultimoRegistro = '';
                });
                
                // Limpiar registros
                localStorage.removeItem(LOGS_KEY);
                localStorage.removeItem(STATE_KEY);
                
                // Actualizar interfaz
                renderizarTrabajadores();
                cargarRegistros();
                
                // Notificaci√≥n
                mostrarNotificacion('üóëÔ∏è Todos los datos han sido limpiados');
                
                // Enviar a App Inventor
                if (window.AppInventor) {
                    window.AppInventor.setWebViewString('limpiado:success');
                }
            }
        }
        
        // 5. VER/OCULTAR REGISTROS
        function toggleLogs() {
            const logsSection = document.getElementById('logsSection');
            if (logsSection.style.display === 'none') {
                logsSection.style.display = 'block';
                mostrarNotificacion('üìã Mostrando registros');
            } else {
                logsSection.style.display = 'none';
            }
        }
        
        // 6. LIMPIAR SOLO REGISTROS (no estado)
        function limpiarRegistros() {
            if (confirm('¬øBorrar solo el historial de registros?\n\nLos trabajadores mantendr√°n su estado actual.')) {
                localStorage.removeItem(LOGS_KEY);
                cargarRegistros();
                mostrarNotificacion('üìù Historial borrado');
            }
        }
        
        // ================= FUNCIONES AUXILIARES =================
        
        function guardarRegistro(mensaje) {
            const logs = obtenerRegistros();
            const hora = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'});
            logs.unshift(`[${hora}] ${mensaje}`);
            
            // Mantener solo √∫ltimos 100 registros
            if (logs.length > 100) logs.length = 100;
            
            localStorage.setItem(LOGS_KEY, JSON.stringify(logs));
            cargarRegistros();
        }
        
        function obtenerRegistros() {
            const logs = localStorage.getItem(LOGS_KEY);
            return logs ? JSON.parse(logs) : [];
        }
        
        function cargarRegistros() {
            const logs = obtenerRegistros();
            const container = document.getElementById('logsContainer');
            
            if (logs.length === 0) {
                container.innerHTML = '<div style="text-align:center; color:#666; padding:20px;">No hay registros hoy</div>';
                return;
            }
            
            container.innerHTML = logs.map(log => 
                `<div class="log-entry">${log}</div>`
            ).join('');
        }
        
        function guardarEstado() {
            const estado = TRABAJADORES.map(t => ({
                id: t.id,
                estado: t.estado,
                ultimoRegistro: t.ultimoRegistro
            }));
            localStorage.setItem(STATE_KEY, JSON.stringify(estado));
        }
        
        function cargarEstado() {
            const guardado = localStorage.getItem(STATE_KEY);
            if (guardado) {
                const estado = JSON.parse(guardado);
                estado.forEach(tGuardado => {
                    const t = TRABAJADORES.find(t => t.id === tGuardado.id);
                    if (t) {
                        t.estado = tGuardado.estado;
                        t.ultimoRegistro = tGuardado.ultimoRegistro;
                    }
                });
            }
        }
        
        function mostrarNotificacion(mensaje) {
            const notif = document.getElementById('notification');
            notif.textContent = mensaje;
            notif.style.display = 'block';
            notif.style.background = '#4CAF50';
            
            setTimeout(() => {
                notif.style.display = 'none';
            }, 3000);
        }
        
        // ================= COMUNICACI√ìN CON APP INVENTOR =================
        
        // Funci√≥n que App Inventor puede llamar
        window.receiveFromAppInventor = function(comando) {
            switch(comando) {
                case 'exportar':
                    exportarDatos();
                    break;
                case 'limpiar':
                    limpiarHoy();
                    break;
                case 'mostrar_logs':
                    toggleLogs();
                    break;
                case 'actualizar':
                    cargarEstado();
                    renderizarTrabajadores();
                    cargarRegistros();
                    break;
            }
        };
        
        // Variable global para App Inventor
        window.AppInventor = {
            setWebViewString: function(text) {
                // Esto es capturado por App Inventor
                console.log("Enviando a App Inventor:", text);
            }
        };
    </script>
</body>
</html>
